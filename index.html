<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <style>
            *{
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            #map {
                display: block;
                height: 100vh;
                width: 100vw;
                margin: auto;
            }
        </style>

        <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>

        <link rel="stylesheet" href="../styles/select-location.css" />
        <link rel="stylesheet" href="../styles/select-vehicle.css" />
        <link rel="stylesheet" href="./styles/navigation.css" />
        <link rel="stylesheet" href="./styles/progress.css" />
        <link rel="stylesheet" href="./styles/package-form.css" />
        <link rel="stylesheet" href="./styles/select-vehicle.css" />
        <link rel="stylesheet" href="./styles/popup.css" />
        <link rel="stylesheet" href="./styles/results.css" />
        <link rel="stylesheet" href="../scripts/swiper/swiper-bundle.min.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

        <title>Delivery Route | Yosam Branding</title>
    </head>
    <body>
        
        <script src="./scripts/logistics.js"></script>

        <style>
            .leaflet-routing-alt{
                display: none !important;
            }
        </style>
        <div id="map"></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
        <script>
            var distance;
            var map = L.map('map').setView([0, 0], 2); // Center map at (0, 0) with zoom level 2
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

            // Define custom icon properties
            var customIcon = L.icon({
                iconUrl: './assets/images/Pickup location icon.png',
                iconSize: [25, 50],
                iconAnchor: [12, 50],
                popupAnchor: [-3, -76]
            });
            
            var customDropLocationIcon = L.icon({
                iconUrl: './assets/images/Destination location icon.png',
                iconSize: [25, 50],
                iconAnchor: [12, 50],
                popupAnchor: [-3, -76]
            });

            // Add marker with custom icon
            var marker = L.marker(map.getCenter(), { icon: customIcon }).addTo(map);
            //var marker1 = L.marker(map.getCenter()).addTo(map); // Add marker at initial center

            const zoomToSelectedLocation = (latitude, longitude) => {
                var selectedLocation = L.latLng(latitude, longitude); // Example selected locatio
                map.setView(selectedLocation, 6); // 15 is the zoom level
            }

            // Function to change marker's icon during movement
            /*function changeIconOnMove() {
                marker.setIcon(L.icon({
                    iconUrl: './assets/images/Map movement icon.png', // New icon URL
                    iconSize: [25, 50],
                    iconAnchor: [12, 50],
                    popupAnchor: [-3, -76]
                }));
            }*/

            var routeLayer, routeLayers = [], control;
            // Function to change marker's icon when movement ends
            /*function changeIconOnMoveEnd() {

                console.log("Map movement ended");

                marker.setIcon(L.icon({
                    iconUrl: './assets/images/Pickup location icon.png', // Original icon URL
                    iconSize: [25, 50],
                    iconAnchor: [12, 50],
                    popupAnchor: [-3, -76]
                }));
                let mapCenter = map.getCenter();
                let location = {
                    latitude:mapCenter.lat,
                    longitude:mapCenter.lng
                };

                if(selectingPickupLocation){
                    //Add a pickup location marker;
                
                    pickupLocation = location;
                    removeMarkerFromMap(pickupLocationMarker);
                    addPickupLocationMarker(mapCenter.lat, mapCenter.lng);
                    marker.bindPopup(`<button onclick='selectLocationOnMoveEnd(${mapCenter.lat}, ${mapCenter.lng})'>Done</button>`).openPopup();
                    //zoomToSelectedLocation(mapCenter.lat, mapCenter.lng);
                } else if(selectingDropLocation){
                    //Add drop location marker;
                    dropLocation = location;
                    removeMarkerFromMap(dropLocationMarker);
                    addDropLocationMarker(mapCenter.lat, mapCenter.lng);
                    marker.bindPopup(`<button onclick='selectLocationOnMoveEnd(${mapCenter.lat}, ${mapCenter.lng})'>Done</button>`).openPopup();
                    //zoomToSelectedLocation(mapCenter.lat, mapCenter.lng);
                }
            }*/

            /*const selectLocationOnMoveEnd = (latitude, longitude) => {
                let location = {
                    latitude:latitude,
                    longitude:longitude
                }

                if(selectingPickupLocation){
                    pickupLocation = location;
                    removeMarkerFromMap(pickupLocationMarker);
                    addPickupLocationMarker(latitude, longitude);
                    map.setView([latitude, longitude], 19); //Zoom in to the location
                    cancelTextSearch();

                    if(dropLocation != undefined){
                        
                        //If drop location is defined, generate the route;
                        generateRoute(pickupLocation, dropLocation);
                    }
                    cancelPickupLocation();
                    marker.closePopup();
                } else if( selectingDropLocation){
                    dropLocation = location;
                    removeMarkerFromMap(dropLocationMarker);
                    addDropLocationMarker(latitude, longitude);
                    map.setView([latitude, longitude], 19); //Zoom in to the location
                    cancelTextSearch();

                    if(pickupLocation != undefined){
                        //If pickup location is defined, generate the route;
                        generateRoute(pickupLocation, dropLocation);
                    }
                    cancelDropLocation();
                    marker.closePopup();
                }
            }*/

            //Function to remove marker from the map
            const removeMarkerFromMap = marker => {
                if(marker){
                    map.removeLayer(marker);
                    marker = undefined;
                }
            }

            //Function to add marker to the map
            function addMarker() {
                if (!marker) {
                    marker = L.marker([51.5, -0.09]).addTo(map);
                } else {
                    alert("Marker already added!");
                }
            }
            
            // Add popup to the marker
            // marker.bindPopup("<button onclick='selectLocation()'>Done</button>").openPopup();

            // Function to update marker position when map is scrolled
            function updateMarkerPosition() {
                marker.setLatLng(map.getCenter());
            }

            // Function to handle click event on the map
            function onMapClick(e) {
                var latitude = e.latlng.lat.toFixed(6);
                var longitude = e.latlng.lng.toFixed(6);
                alert("Latitude: " + latitude + "\nLongitude: " + longitude);
            }

            // Update marker position when map is moved
            //map.on('move', updateMarkerPosition);

            // Change marker's icon during movement
            //map.on('move', changeIconOnMove);

            // Change marker's icon when movement ends
            //map.on('moveend', changeIconOnMoveEnd);

            // Center marker initially
            updateMarkerPosition();

            // Attach click event listener to the map
            //map.on('click', onMapClick);

            var pickupLocationMarker;
            var dropLocationMarker;

            const addPickupLocationMarker = (latitude, longitude) => {
                pickupLocationMarker = L.marker([latitude, longitude], { icon:customIcon}).addTo(map);
                /**
                    * Zoom in to the location
                */
            }

            const addDropLocationMarker = (latitude, longitude) => {
                dropLocationMarker = L.marker([latitude, longitude], { icon:customDropLocationIcon}).addTo(map);
            }

            const selectPlace = (latitude, longitude) => {
                //document.getElementById('result').innerHTML = 'Latitude: ' + latitude + '<br>Longitude: ' + longitude;
                /**
                    * Store the informatin in the correct locations;
                    */

                console.log("Location selected");
                let location = {
                    latitude:latitude,
                    longitude:longitude
                }

                if(selectingPickupLocation){
                    pickupLocation = location;
                    removeMarkerFromMap(pickupLocationMarker);
                    addPickupLocationMarker(latitude, longitude);
                    map.setView([latitude, longitude], 19); //Zoom in to the location
                    cancelTextSearch();

                    if(dropLocation != undefined){
                        /**
                            * If drop location is defined, generate the route;
                            * */
                        generateRoute(pickupLocation, dropLocation);
                    }
                    cancelPickupLocation();
                    marker.closePopup();
                } else if( selectingDropLocation){
                    dropLocation = location;
                    removeMarkerFromMap(dropLocationMarker);
                    addDropLocationMarker(latitude, longitude);
                    map.setView([latitude, longitude], 19); //Zoom in to the location
                    cancelTextSearch();

                    if(pickupLocation != undefined){
                        /*
                        * If pickup location is defined, generate the route;
                        */
                        generateRoute(pickupLocation, dropLocation);
                    }
                    cancelDropLocation();
                    marker.closePopup();
                }
            }

            // Define your locations as an array of objects with latitude and longitude
            /*const locations = [
                { lat: 40.748817, lng: -73.985428 }, // Example: New York
                { lat: 40.80817, lng: -73.995428 },   // Example: Paris
                { lat: 40.80917, lng: -73.996428 }   // Example: London
                // Add more locations as needed
            ];*/

            const locations = [
                //{ "name":"Rebecca Mghoi", "latitude":"-1.5157379", "longitude":"36.9465662", "phone":"+254704189138", "location":"St. Mary's Lang'ata"},
                //{ "name":"Billy Labatt", "latitude":"-1.2m840791", "longitude":"36.9001066", "phone":"+254725159157", "location":"Jacaranda Estate Donholm"},
                // Check delivery{ "name":"Belinda Mwangi", "latitude":"-1.2203155", "longitude":"36.740592", "phone":"+254703543468", "location":"Ekaya Gardens Gathiga"},
                //{ "name":"Kevin Kemboi", "latitude":"-1.3300051", "longitude":"36.8636155", "phone":"+254711790179", "location":"Sameer Business Park"},
                //{ "name":"Roger Mwaniki", "latitude":"-1.1947164", "longitude":"36.9463247", "phone":"+254790291762", "location":"Raha Max, Kahawa Sukari"},
                //{ "name":"Ann Wamuyu Kamara", "latitude":"-1.1590188", "longitude":"36.9189009", "phone":"+254715006859", "location":"Serengeti Court Membley Ruiru hse 100"},
                // Check delivery{ "name":"Jane Wanjiru Mwangi", "latitude":"-1.1675464", "longitude":"36.96896", "phone":"+254791042412", "location":"Twins apartment nairobi, Kamakis"},
                //{ "name":"Erick Mumo Mutua", "latitude":"-1.2079328", "longitude":"36.8954852", "phone":"+254722357132", "location":"Eagles Apartment, Zimmerman"},
                //{ "name":"Jimmy Githinji Kereka", "latitude":"-1.185384", "longitude":"36.9029659", "phone":"+254790911882", "location":"Yellow cafeteria opposite Family bank, Kahawa west"},
                //{ "name":"Cetrick Afundi", "latitude":"-1.3235455", "longitude":"36.8765284", "phone":"+254115685790", "location":"Nandi flame road, nairobi"},
                //{ "name":"Grace mumo", "latitude":"-1.2678776", "longitude":"36.7230186", "phone":"+254713748708", "location":"Sabatia court, naivasha road"},
                //{ "name":"Hildah Azangalala", "latitude":"-1.3079343", "longitude":"36.8119502", "phone":"+254718954325", "location":"Karuri Court, Madaraka"},
                //{ "name":"Erick Wamalwa Barasa", "latitude":"-1.3217193", "longitude":"36.9009177", "phone":"+254707819550", "location":"Airport N Road, Nairobi"},
                // Check delivery{ "name":"Michael Tsuma", "latitude":"-1.2092227", "longitude":"36.7821499", "phone":"+254718365153", "location":"White house apartments Ruaka"},
                //{ "name":"Tina Aruka", "latitude":"-1.1839394", "longitude":"36.8834779", "phone":"+254723040799", "location":"Opposite Friends Church Kahawa West"},
                //{ "name":"Glein Tora", "latitude":"-1.2178849", "longitude":"36.8977021", "phone":"+254718537232", "location":"Equity bank Kasarani"},
                // Check delivery{ "name":"Nuh Chirewe Dzambo", "latitude":"-1.3300626", "longitude":"36.8624841", "phone":"+254717952533", "location":"Sameer Business Park"},
                //{ "name":"Antony Ndambuki", "latitude":"-1.2766033", "longitude":"36.897521", "phone":"+254701751442", "location":"Nasra Garden Estate, Kayole spine road"},
                //{ "name":"Calvin Imbigu", "latitude":"-1.229664", "longitude":"36.9203053", "phone":"+254725835760", "location":"Total, Sunton, Kasarani"},
                //{ "name":"Mark Muthama Kilungya", "latitude":"-1.2888955", "longitude":"36.9478818", "phone":"+254715702437", "location":"Utawala shooters"},
                //{ "name":"Elizabeth Nkirote Wanjiru", "latitude":"-1.1933275", "longitude":"36.9502354", "phone":"+254701221937", "location":"House no 025, taita taveta rd kahawa sukari"},
                // Check delivery{ "name":"James Kithendu Katiwa", "latitude":"-1.0598627", "longitude":"37.0923113", "phone":"+254795802180", "location":"Makongeni, Thika"},
                //{ "name":"Lawrence Owino", "latitude":"-1.1984742", "longitude":"36.920967", "phone":"+254714562519", "location":"Kahawa wendani opposite linca apartment next to denver court"},
                //{ "name":"Basil Omolo", "latitude":"-1.3300626", "longitude":"36.8624841", "phone":"+254702608321", "location":"Sameer Business Park"},
                
                { "name":"Daniel Kuria", "latitude":"-1.2833624", "longitude":"36.8172196", "phone":"", "location":"Windsor House"},
              //  { "name":"Lewis Wachira Muriuki", "latitude":"-1.2101715", "longitude":"36.9051706", "phone":"+254729466985", "location":"Kona apartment, zimmerman"},
               // { "name":"Yvonne Kiragu", "latitude":"-1.21529", "longitude":"36.8996177", "phone":"+254721341142", "location":"Bethel plaza kasarani"},
                
               { "name":"Sheila Nthiga", "latitude":"-1.1749135", "longitude":"36.8427945", "phone":"+254718432238", "location":"Victory apartments Kirigiti kiambu"},
                //{ "name":"Joseph Nganga Njuguna", "latitude":"-1.2324779", "longitude":"36.876205", "phone":"+254708827181", "location":"Garden City Mall, roasters"},
                
                { "name":"Peris Wambui Njoroge", "latitude":"-1.2919408", "longitude":"36.8216118", "phone":"+254702355678", "location":"Tiled Building behind Equity bank, Donholm, Caltex."},
               // { "name":"Morgan Kong'ola", "latitude":"-1.2049996", "longitude":"36.8986654", "phone":"+254714364436", "location":"Zimmerman SDA, Roysambu"},
                // Check delivery { "name":"Moses Watakila Wawire", "latitude":"-1.2952737", "longitude":"36.7442237", "phone":"+254718930471", "location":"Dagoretti corner, mutindwa"},
                //{ "name":"Seth Mboya", "latitude":"-1.3141947", "longitude":"36.890744", "phone":"+254719414109", "location":"Embakasi, kwa ndege, fedha"},
                
                { "name":"Tony Korir", "latitude":"-1.194918", "longitude":"36.7378284", "phone":"+254734652413", "location":"JD Apartments, Kinoo"},
                
                { "name":"Jane Wambui", "latitude":"-1.3800143", "longitude":"36.9384971", "phone":"+254741543180", "location":"Camden Court, Hse D3, Mlolongo"},
                // Check delivery{ "name":"Mark Kidula Agonya", "latitude":"-1.3187671", "longitude":"36.8334672", "phone":"+254713820512", "location":"Mirage Plaza, Mombasa Road"},
                // Check delivery{ "name":"Hannah Mwabili", "latitude":"-1.2403389", "longitude":"36.8993958", "phone":"+254720002073", "location":"Kevike Plaza Apartment, Lucky Summer Thika Road"},
                //{ "name":"Timothy Kimani Njoroge", "latitude":"-1.2177544", "longitude":"36.8835205", "phone":"+254113578474", "location":"Jowanya Apartments House No. V5, TRM Drive"},
                //{ "name":"Leah Atieno Ouma", "latitude":"-1.2068928", "longitude":"36.780237", "phone":"+254702954311", "location":"Townshed Apartment, Carlifonia Road"},
                //{ "name":"Sharon Atieno Otieno", "latitude":"-1.301932", "longitude":"36.8105341", "phone":"+254725557144", "location":"KCB Towers , Upperhill, 12th floor, Kenya Road"},
                
                { "name":"Emmeldah Millicent Amollh", "latitude":"-1.2784297", "longitude":"36.9545938", "phone":"+254723487709", "location":"Utawala kwa chief ( Innovation court )"},
                //{ "name":"Phoebian Otieno Olalo", "latitude":"-1.1947963", "longitude":"36.9305343", "phone":"+254790304601", "location":"RAHA MAX APARTMENT, OFF BARINGO ROAD"},
                // Check delivery{ "name":"Odhiambo Kevin Juma", "latitude":"-1.1017801", "longitude":"37.0213465", "phone":"+254712830953", "location":"LK appartment, Juja"},
                //{ "name":"John Mukaburu Muriithi", "latitude":"-1.1495293", "longitude":"36.960392", "phone":"+254717005933", "location":"Jiji towers Ruiru"},
                //{ "name":"Alice Oketch", "latitude":"-1.2799172", "longitude":"36.6591246", "phone":"+254704910116", "location":"Cloisters park thogoto, Damacitest School Thogoto"},
                //{ "name":"Caroline Muthoni Kimaru", "latitude":"-1.3047778", "longitude":"36.9010728", "phone":"+254725606001", "location":"Embakasi kwa ndege"},
                // Check delivery{ "name":"David Njoki", "latitude":"-1.1366381", "longitude":"36.9790507", "phone":"+254717504844", "location":"Kimbo-Matangi rd, Murera police post, Muturi's apt, Hse B2"},
                
                { "name":"Sarah Achieng Nyawir", "latitude":"-1.2503847", "longitude":"36.9520115", "phone":"+254714268009", "location":"Midax petrol station, chokaa"},
                //{ "name":"Joseph Muriithi Ndiragu", "latitude":"-1.2089519", "longitude":"36.7845146", "phone":"+254710785291", "location":"White House Apartments - House number G7 along Ruaka- Banana Road"},
                //{ "name":"Josephine Muchiri", "latitude":"-1.2173129", "longitude":"36.8850518", "phone":"+254717034444", "location":"Amani Apartments, Roysambu"},
                //{ "name":"Kelvin Kuria", "latitude":"-1.1598579", "longitude":"36.9508445", "phone":"+254768737382", "location":"Brokeshade Apartment, ruiru"},
                
                { "name":"Donatus Waruiru Kamau", "latitude":"-1.1059368", "longitude":"36.9567948", "phone":"+254711822440", "location":"Mugutha, Ruiru"},
                
                { "name":"Collins Kiptoo", "latitude":"-1.3525346", "longitude":"36.6616001", "phone":"+254704969868", "location":"Ngong town kibiko"},
                
                //Recheck latitude and longitude.
                { "name":"Brian Onyango", "latitude":"-1.2785391", "longitude":"37.1328986", "phone":"+254708373457", "location":"Twinfall city, Mathaa Kangundo road"},
                //{ "name":"Hezbon Ocharo", "latitude":"-1.2175065", "longitude":"36.8853725", "phone":"+254725885312", "location":"Amani Apartment, Lumumba drive"},
                //{ "name":"Vivian Mwendwa", "latitude":"-1.2059524", "longitude":"36.7747576", "phone":"+254702958107", "location":"Amani Apartment, Lumumba drive"},
                //{ "name":"Ruth Wangari Gichina", "latitude":"-1.3245191", "longitude":"36.8782714", "phone":"+254723039658", "location":"Muimara Estate, Sideview Apartment"},
                { "name":"Hartmut Kalume", "latitude":"-1.0332814", "longitude":"37.0752086", "phone":"+254702570516", "location":"Kiambu mama lucia plaza, upper road thika"},
                
                { "name":"Isaac Mutunga Kitwaa", "latitude":"-1.2697992", "longitude":"36.8829574", "phone":"+254715133199", "location":"Ravine Apartment, Mutarakwa Road"},
                //{ "name":"Brenda Okumu", "latitude":"-1.2842767", "longitude":"36.8897098", "phone":"+254713232717", "location":"Peacock Stage, Olombori Road Umoja 1"},
                //{ "name":"Eliud Gachochu", "latitude":"-1.3019698", "longitude":"36.9011099", "phone":"+254725441831", "location":"Tassia"},
                
                { "name":"Alvin Muchui", "latitude":"-1.0297411", "longitude":"37.0676672", "phone":"+254720943557", "location":"Section 2, thika"},
                
                { "name":"Martin Muya", "latitude":"-1.0297411", "longitude":"37.0676672", "phone":"+254707820490", "location":"Section 2, thika"},
                // Check delivery{ "name":"Antony Omondi Odhiambo(Ann Adhiambo)", "latitude":"-1.0297411", "longitude":"37.0676672", "phone":"+254717137428", "location":"Nairobi"},
                
                { "name":"Enock Chacha Mwita", "latitude":"-1.3923809", "longitude":"36.7693371", "phone":"+254703852583", "location":"Century Apartments"},
                // Check delivery{ "name":"Hamisi Shambi", "latitude":"-1.1859754", "longitude":"36.8986039", "phone":"+254729599659", "location":"Hope Classic, Kahawa west"},
                //{ "name":"James Kitonga Maluki", "latitude":"-1.2370424", "longitude":"36.9337762", "phone":"+254720425001", "location":"ACK Road 4th Street, Kenrose House"},
                // Check delivery{ "name":"Martin Wachogi Mwangi", "latitude":"0.0080478", "longitude":"36.361626", "phone":"+254714756501", "location":"Sudav Apartments, Nyahururu-Gilgil Road Runda B Estate-Nyahururu"},
                //{ "name":"Eunice Njeri Wanjiru", "latitude":"-1.2470326", "longitude":"36.6784581", "phone":"+254722916059", "location":"Regen Kikuyu"},
                //{ "name":"Agnes Kithei Mutuku", "latitude":"-1.2063192", "longitude":"36.7746316", "phone":"+254714890551", "location":"The Stables Apartment Ruaka, House C4, 4th Floor"},
                // Check delivery{ "name":"Bob Omira Ojwang", "latitude":"-1.2791155", "longitude":"36.8878859", "phone":"+254714424839", "location":"Hornbill, Moi Drive, Umoja 1 Estate"},
                //{ "name":"Fridah Kirare", "latitude":"-1.1850147", "longitude":"36.9055404", "phone":"+254723825770", "location":"Kamae rd kahawa west"},
                //{ "name":"Ruth Okutoh", "latitude":"-1.2084882", "longitude":"36.7752508", "phone":"+254713730562", "location":"The Loftel, Rosslyn Slaughter Road"},
                //{ "name":"Timothy Owenda", "latitude":"-1.2879701", "longitude":"36.882021", "phone":"+254714574897", "location":"Mumias South Road, Amasya Crescent, BuruBuru Phase 4"},
                
                { "name":"Harrison Otieno", "latitude":"-1.2810825", "longitude":"36.8079823", "phone":"+254799820376", "location":"University of Nairobi"},
                
                { "name":"Susan Ouma", "latitude":"-1.3975468", "longitude":"36.7586399", "phone":"+254703910909", "location":"Sironik Road, Rongai"},
                
                { "name":"Elizabeth Kalekye Mutua", "latitude":"-1.363592", "longitude":"36.9184932", "phone":"+254711267990", "location":"Ferndale Court, Syokimau, HSE 4"},
                
                { "name":"John Oduor", "latitude":"-1.363592", "longitude":"36.9184932", "phone":"+254706814216", "location":"Kitengela, posta"},
                
                { "name":"Douglas Mwavita Mwarumba", "latitude":"-1.3141738", "longitude":"36.8925677", "phone":"+254720387192", "location":"Fedha Kwa Ndege, Tassia"},
                
                { "name":"Douglas Mwavita Mwarumba", "latitude":"-1.3141738", "longitude":"36.8925677", "phone":"+254720387192", "location":"Fedha Kwa Ndege, Tassia"},
                
                { "name":"Valerie Mukasia", "latitude":"-1.2257693", "longitude":"36.886121", "phone":"+254725013508", "location":"Apartment D15, Kasarani"},
                
                { "name":"Nelson Tum", "latitude":"-1.394124", "longitude":"36.7594629", "phone":"+254714512012", "location":"Maasai mall ongata rongai"},
                
                { "name":"Edmund Congo", "latitude":"-1.2634422", "longitude":"36.7133693", "phone":"+15623842329", "location":"Onyx Place Apartments"},
                
                { "name":"susan santanyian kasoo", "latitude":"-1.4459061", "longitude":"36.9424106", "phone":"+254798070737", "location":"Athi River"},
            ];

            let locationMarkers = [];
            const generateRoute = (locations) => {

                let waypoints = [];
                locations.forEach((location, index) => {
                    waypoints.push(L.latLng(location.latitude, location.longitude));
                });

                console.log(waypoints);
                /*var startPoint = L.latLng(pickupLocation.latitude, pickupLocation.longitude); // Example start point
                var endPoint = L.latLng(dropLocation.latitude, dropLocation.longitude);   // Example end point*/
                if(control) control.setWaypoints([]);

                control = L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: true,
                    lineOptions: {
                        styles: [{color: 'blue', opacity: 0, weight: 5}],
                        show: false // Disable directions popup
                    },
                    createMarker: function() { return null; }, // Disable markers
                    addWaypoints: false, // Disable adding waypoints
                    show: false, // Disable adding waypoints
                    draggableWaypoints: false, // Disable adding waypoints

                    // Custom formatter to suppress instructions
                    formatter: new L.Routing.Formatter({
                        language: 'en',
                        units: 'metric',
                        formatInstruction: function() { return ''; } // Return an empty string for instructions
                    })
                }).addTo(map);

                control.on('routesfound', function (e) {
                    /**
                        * Zoom in to the route;
                        */
                    boundMap(waypoints[0], waypoints[waypoints.length-1]);
                    var routes = e.routes;
                    console.log(e.routes);
                    //routeLayer = routes[0].route; // Store the route layer
                    //routeLayers.push(routeLayer);
                    distance = routes[0].summary.totalDistance; // Distance in meters
                    //logisticsEstimate(distance, selectedVehicle.rate_per_km);
                });

                /*
                    For each location add marker and bind popup
                */
                let i = 0;
                
                for(i = 0; i < locations.length; i++){
                    locationMarkers[i] = L.marker([locations[i].latitude, locations[i].longitude], { icon:customIcon}).addTo(map);
                    locationMarkers[i].bindPopup(`<p>${locations[i].name}</p><p>${locations[i].location}</p><a href='tel:${locations[i].phone}'>${locations[i].phone}</a>`).openPopup();
                }
            }
            generateRoute(locations);
            // const generateRoute = (pickupLocation, dropLocation) => {

            //     console.log("Generating route");
            //     var startPoint = L.latLng(pickupLocation.latitude, pickupLocation.longitude); // Example start point
            //     var endPoint = L.latLng(dropLocation.latitude, dropLocation.longitude);   // Example end point

            //     if(control) control.setWaypoints([]);

            //     control = L.Routing.control({
            //         waypoints: [
            //             startPoint,
            //             endPoint
            //         ],
            //         routeWhileDragging: true,
            //         lineOptions: {
            //             styles: [{color: 'blue', opacity: 0.7, weight: 5}],
            //             show: false // Disable directions popup
            //         },
            //         createMarker: function() { return null; }, // Disable markers
            //         addWaypoints: false // Disable adding waypoints
            //     }).addTo(map);

            //     control.on('routesfound', function (e) {
            //         boundMap(pickupLocation, dropLocation);
            //         var routes = e.routes;
            //         //console.log(e.routes);
            //         //routeLayer = routes[0].route; // Store the route layer
            //         //routeLayers.push(routeLayer);
            //         distance = routes[0].summary.totalDistance; // Distance in meters
            //         logisticsEstimate(distance, selectedVehicle.rate_per_km);
            //     });
            // }

            const boundMap = (start, end) => {
                
                let location1 = [start.lat, start.lng];
                let location2 = [end.lat, end.lng];

                var bounds = [location1, location2];

                map.fitBounds(bounds,{
                    padding: [3, 3],
                    animate: true,
                    pan: true,
                    //maxZoom: 5
                });
            }

            function clearRoutes() {
                routeLayers.forEach(function (layer) {
                    map.removeLayer(layer); // Remove each route layer from the map
                });
                routeLayers = []; // Clear the array
            }

            // Create a marker variable (will be initialized once we get the user's position)
            let userMarker;
            let currentLocation = {};
            // Function to update the user's location every second
            // Function to update the user's location every second with high accuracy
            function trackUserLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        position => {
                            const { latitude, longitude, accuracy } = position.coords;

                            currentLocation.latitude = latitude;
                            currentLocation.longitude = longitude;

                            // Log accuracy to monitor if it's within acceptable limits
                            console.log(`Location accuracy: ${accuracy} meters`);

                            // If marker exists, update its position
                            if (userMarker) {
                                userMarker.setLatLng([latitude, longitude]);
                            } else {
                                // Create marker for the first time with accuracy circle
                                userMarker = L.marker([latitude, longitude]).addTo(map);
                                L.circle([latitude, longitude], { radius: accuracy }).addTo(map);
                            }

                            // Center map to user's location
                            //map.setView([latitude, longitude], 15);
                        },
                        error => {
                            console.error("Geolocation error:", error);
                        },
                        {
                            enableHighAccuracy: true,   // Requests the most accurate location possible
                            timeout: 10000,            // Maximum time (in ms) to wait for location
                            maximumAge: 0              // Prevents using cached location data
                        }
                    );
                } else {
                    console.log("Geolocation is not supported by this browser.");
                }
            }

            // Call the function to start tracking
            trackUserLocation();

            // Initialize the routing engine
            const router = L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1'
            });

            // Function to find the shortest route through all locations iteratively
            /*async function findShortestIterativeRoute(locations) {
                if (locations.length < 2) {
                    console.error("At least two locations are required to calculate a route.");
                    return;
                }

                // Start from the first location
                let currentLocation = locations[0];
                let routeOrder = [currentLocation];
                let unvisitedLocations = locations.slice(1); // Exclude the first location

                while (unvisitedLocations.length > 0) {
                    let closestLocation = null;
                    let shortestDistance = Infinity;

                    // Find the closest location to the current location
                    for (let location of unvisitedLocations) {
                        const distance = await calculateRouteDistance(currentLocation, location);
                        if (distance < shortestDistance) {
                            shortestDistance = distance;
                            closestLocation = location;
                        }
                    }

                    // Add the closest location to the route order
                    routeOrder.push(closestLocation);

                    // Update current location and remove visited location from unvisited list
                    currentLocation = closestLocation;
                    unvisitedLocations = unvisitedLocations.filter(loc => loc !== closestLocation);
                }

                // Display the final route
                displayRoute(routeOrder);
            }*/

            // Helper function to calculate route distance between two locations using L.Routing.Control
            /*function calculateRouteDistance(start, end) {
                return new Promise((resolve, reject) => {
                    // const routingControl = L.Routing.control({
                    //     waypoints: [
                    //         L.latLng(start.latitude, start.longitude),
                    //         L.latLng(end.latitude, end.longitude)
                    //     ],
                    //     routeWhileDragging: false,
                    //     createMarker: () => null,  // Do not display markers for intermediate calculations
                    // }).addTo(map);

                    // // Calculate distance after the route is found
                    // routingControl.on('routesfound', function(event) {
                    //     const distance = event.routes[0].summary.totalDistance; // Distance in meters
                    //     resolve(distance);
                    //     map.removeControl(routingControl); // Clean up temporary routing control
                    // });

                    // routingControl.on('routingerror', function(error) {
                    //     reject(error);
                    //     map.removeControl(routingControl); // Clean up even on error
                    // });

                    const routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(start.latitude, start.longitude),
                            L.latLng(end.latitude, end.longitude)
                        ],
                        routeWhileDragging: false,
                        createMarker: function() { return null; }, // Disable markers
                        addWaypoints: false, // Disable adding waypoints
                        show: false, // Disable adding waypoints
                        draggableWaypoints: false, // Disable adding waypoints

                        // Custom formatter to suppress instructions
                        formatter: new L.Routing.Formatter({
                            language: 'en',
                            units: 'metric',
                            formatInstruction: function() { return ''; } // Return an empty string for instructions
                        })
                    }).addTo(map);

                    routingControl.on('routesfound', function (e) {

                        //boundMap(waypoints[0], waypoints[waypoints.length-1]);
                        var routes = e.routes;
                        console.log(e.routes);
                        //routeLayer = routes[0].route; // Store the route layer
                        //routeLayers.push(routeLayer);
                        distance = routes[0].summary.totalDistance; // Distance in meters
                        resolve(distance);
                        //map.removeControl(routingControl); // Clean up temporary routing control
                        //logisticsEstimate(distance, selectedVehicle.rate_per_km);
                    });

                    routingControl.on('routingerror', function(error) {
                        reject(error);
                        //map.removeControl(routingControl); // Clean up even on error
                    });
                });
            }*/

            // Helper function to display the final route on the map
            /*function displayRoute(locations) {
                const waypoints = locations.map(loc => L.latLng(loc.latitude, loc.longitude));

                L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: false,
                    createMarker: function(i, waypoint, n) {
                        return L.marker(waypoint.latLng, {
                            draggable: false,
                            title: `Stop ${i + 1}`
                        }).bindPopup(`Stop ${i + 1}`);
                    }
                }).addTo(map);

                // Center the map on the route
                map.fitBounds(L.latLngBounds(waypoints));
            }*/

            // Helper function to display the final route on the map with unique colors for each segment
            /*function displayRoute(locations) {
                const waypoints = locations.map(loc => L.latLng(loc.latitude, loc.longitude));

                // Array of colors to choose from for each segment
                const colors = ['#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#A1FF33', '#33A1FF', '#FF5733'];

                // Iterate over waypoints to create line segments with different colors
                for (let i = 0; i < waypoints.length - 1; i++) {
                    const start = waypoints[i];
                    const end = waypoints[i + 1];

                    // Create a polyline for each segment with a different color
                    L.polyline([start, end], {
                        color: colors[i % colors.length], // Cycle through the colors array
                        weight: 5,
                        opacity: 0.8
                    }).addTo(map);

                    // Optionally, add markers for each waypoint
                    L.marker(start, { title: `Stop ${i + 1}` }).bindPopup(`Stop ${i + 1}`).addTo(map);
                }

                // Add a marker for the final waypoint
                L.marker(waypoints[waypoints.length - 1], { title: `Stop ${waypoints.length}` })
                    .bindPopup(`Stop ${waypoints.length}`)
                    .addTo(map);

                // Center the map on the full route
                map.fitBounds(L.latLngBounds(waypoints));
            }*/

            // Call the function to calculate and display the shortest route iteratively
            //findShortestIterativeRoute(locations);

            setInterval(() => {
                findAndRouteClosestLocation(currentLocation, locations);
            }, 2000);
            // Function to find the closest location to the user's current location and generate a route
            async function findAndRouteClosestLocation(userLocation, locations) {
                if (locations.length === 0) {
                    console.error("No locations provided to find the closest location.");
                    return;
                }

                let closestLocation = null;
                let shortestDistance = Infinity;

                // Find the closest location
                for (let location of locations) {
                    const distance = await calculateRouteDistance(userLocation, location);
                    if (distance < shortestDistance) {
                        shortestDistance = distance;
                        closestLocation = location;
                    }
                }

                // Display route to the closest location if found
                if (closestLocation) {
                    displayRouteToClosest(userLocation, closestLocation);
                } else {
                    console.error("Could not determine the closest location.");
                }
            }

            // Helper function to calculate route distance between two locations using L.Routing.Control
            function calculateRouteDistance(start, end) {
                return new Promise((resolve, reject) => {
                    const routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(start.latitude, start.longitude),
                            L.latLng(end.latitude, end.longitude)
                        ],
                        routeWhileDragging: false,
                        createMarker: () => null,  // Suppress intermediate markers
                    }).addTo(map);

                    // Calculate distance after the route is found
                    routingControl.on('routesfound', function(event) {
                        const distance = event.routes[0].summary.totalDistance; // Distance in meters
                        resolve(distance);
                        map.removeControl(routingControl); // Clean up temporary routing control
                    });

                    routingControl.on('routingerror', function(error) {
                        reject(error);
                        map.removeControl(routingControl); // Clean up on error
                    });
                });
            }

            // Helper function to display the route from user's location to the closest location
            function displayRouteToClosest(userLocation, closestLocation) {
                const waypoints = [
                    L.latLng(userLocation.latitude, userLocation.longitude),
                    L.latLng(closestLocation.latitude, closestLocation.longitude)
                ];

                // Use L.Routing.Control to display the route
                L.Routing.control({
                    waypoints: waypoints,
                    routeWhileDragging: false,
                    createMarker: function(i, waypoint, n) {
                        const title = i === 0 ? 'Your Location' : 'Closest Location';
                        return L.marker(waypoint.latLng, {
                            draggable: false,
                            title: title
                        }).bindPopup(title);
                    },
                    lineOptions: {
                        styles: [{ color: '#3388ff', weight: 5, opacity: 0.8 }]
                    }
                }).addTo(map);

                // Center the map to fit the route
                map.fitBounds(L.latLngBounds(waypoints));
            }

            // Call the function with the user's current location and other locations
           // const userLocation = { latitude: userLatitude, longitude: userLongitude };
            findAndRouteClosestLocation(userLocation, locations);
        </script>
        
    </body>
</html>
